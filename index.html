<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PG-PMS | Team Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="max-w-md w-full glass-card p-8 rounded-2xl shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl">
                    <i class="fas fa-layer-group"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">PG-PMS Login</h1>
                <p class="text-slate-500 mt-2">Enter your GitHub Token to access the workspace</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="gh-token" placeholder="Paste Passcode (ghp_...)" 
                       class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <button onclick="initWorkspace()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl transition-all shadow-lg hover:shadow-blue-200">
                    Connect to Workspace
                </button>
                <p class="text-xs text-center text-slate-400">Your token is stored locally in your browser and never shared elsewhere.</p>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-content" class="max-w-5xl mx-auto px-4 py-8 hidden">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">SIH Project Dashboard</h1>
                <p class="text-slate-500" id="current-user-display">Welcome back!</p>
            </div>
            <div class="flex gap-2">
                <button onclick="syncData()" class="bg-white border border-slate-200 px-4 py-2 rounded-lg hover:bg-slate-50 transition flex items-center gap-2 shadow-sm">
                    <i class="fas fa-sync" id="sync-icon"></i> Refresh
                </button>
                <button onclick="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 transition shadow-sm">
                    Logout
                </button>
            </div>
        </header>

        <!-- STATS / PROGRESS -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-blue-500">
                <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Overall Progress</p>
                <div class="mt-2 flex items-end justify-between">
                    <span class="text-3xl font-bold text-slate-800" id="stat-percent">0%</span>
                    <span class="text-sm text-blue-600 font-medium" id="stat-counts">0 / 0 Tasks</span>
                </div>
                <div class="w-full bg-slate-100 h-2 rounded-full mt-4 overflow-hidden">
                    <div id="progress-fill" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-orange-500">
                <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Pending Tasks</p>
                <h3 class="text-3xl font-bold text-slate-800 mt-2" id="stat-pending">0</h3>
            </div>

            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-green-500">
                <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Completed Today</p>
                <h3 class="text-3xl font-bold text-slate-800 mt-2" id="stat-today">0</h3>
            </div>
        </div>

        <!-- TASK INPUT -->
        <div class="glass-card p-4 rounded-2xl shadow-sm mb-8 flex gap-2">
            <input type="text" id="task-input" placeholder="What needs to be done?" 
                   class="flex-1 bg-transparent border-none px-4 py-2 focus:outline-none text-lg">
            <button onclick="addTask()" class="bg-slate-900 text-white px-6 py-2 rounded-xl hover:bg-slate-800 transition shadow-md">
                Add Task
            </button>
        </div>

        <!-- TASK LIST -->
        <div class="space-y-4" id="task-container">
            <!-- Tasks will be injected here -->
            <div class="text-center py-20 text-slate-400">
                <i class="fas fa-tasks text-4xl mb-4"></i>
                <p>Loading your project workspace...</p>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION - CHANGE THIS
        const CONFIG = {
            owner: "Pugajjar", // Your GitHub Username
            repo: "pg-pms",                // Your Repo Name
            path: "tasks.json"             // The JSON file
        };

        let state = {
            tasks: [],
            sha: null,
            token: null,
            username: ""
        };

        // --- CORE FUNCTIONS ---

        async function initWorkspace() {
            const tokenInput = document.getElementById('gh-token').value.trim();
            if(!tokenInput) return alert("Please enter your token!");
            
            state.token = tokenInput;
            const success = await syncData();
            
            if(success) {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                localStorage.setItem('pms_token', tokenInput);
            }
        }

        async function syncData() {
            const syncIcon = document.getElementById('sync-icon');
            syncIcon.classList.add('fa-spin');

            try {
                const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                    headers: { "Authorization": `token ${state.token}` }
                });

                if(!response.ok) throw new Error("Failed to fetch");

                const data = await response.json();
                state.sha = data.sha;
                // decode base64 content
                state.tasks = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                
                render();
                return true;
            } catch (err) {
                alert("Error: Could not connect to GitHub. Check your token and repo name.");
                return false;
            } finally {
                syncIcon.classList.remove('fa-spin');
            }
        }

        async function pushUpdate(message = "Update project state") {
            try {
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(state.tasks, null, 2))));
                const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                    method: "PUT",
                    headers: { 
                        "Authorization": `token ${state.token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: message,
                        content: content,
                        sha: state.sha
                    })
                });

                const data = await response.json();
                state.sha = data.content.sha; // Update SHA for next write
                render();
            } catch (err) {
                alert("Failed to save changes. Try refreshing.");
            }
        }

        // --- ACTIONS ---

        async function addTask() {
            const input = document.getElementById('task-input');
            const text = input.value.trim();
            if(!text) return;

            const newTask = {
                id: Date.now(),
                text: text,
                completed: false,
                createdAt: new Date().toISOString(),
                completedAt: null,
                author: "Team Member" 
            };

            state.tasks.unshift(newTask);
            input.value = "";
            await pushUpdate(`Add task: ${text}`);
        }

        async function toggleTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if(!task) return;

            task.completed = !task.completed;
            task.completedAt = task.completed ? new Date().toISOString() : null;
            
            await pushUpdate(`${task.completed ? 'Completed' : 'Reopened'}: ${task.text}`);
        }

        async function deleteTask(id) {
            if(!confirm("Delete this task?")) return;
            state.tasks = state.tasks.filter(t => t.id !== id);
            await pushUpdate("Deleted a task");
        }

        // --- UI RENDERING ---

        function render() {
            const container = document.getElementById('task-container');
            const completedCount = state.tasks.filter(t => t.completed).length;
            const totalCount = state.tasks.length;
            const percent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

            // Update Stats
            document.getElementById('stat-percent').innerText = percent + "%";
            document.getElementById('stat-counts').innerText = `${completedCount} / ${totalCount} Tasks`;
            document.getElementById('progress-fill').style.width = percent + "%";
            document.getElementById('stat-pending').innerText = totalCount - completedCount;
            
            const today = new Date().toISOString().split('T')[0];
            const completedToday = state.tasks.filter(t => t.completed && t.completedAt?.startsWith(today)).length;
            document.getElementById('stat-today').innerText = completedToday;

            // Render List
            if(totalCount === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-400"><p>No tasks yet. Start by adding one above!</p></div>`;
                return;
            }

            container.innerHTML = state.tasks.map(task => `
                <div class="glass-card p-5 rounded-2xl shadow-sm flex items-center justify-between animate-fade ${task.completed ? 'opacity-60' : ''}">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleTask(${task.id})" class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${task.completed ? 'bg-green-500 border-green-500 text-white' : 'border-slate-200 hover:border-blue-500'}">
                            ${task.completed ? '<i class="fas fa-check"></i>' : ''}
                        </button>
                        <div>
                            <h3 class="font-semibold ${task.completed ? 'line-through text-slate-400' : 'text-slate-800'}">${task.text}</h3>
                            <p class="text-xs text-slate-400 mt-1">
                                <i class="far fa-calendar-alt mr-1"></i> ${new Date(task.createdAt).toLocaleDateString()} 
                                ${task.completedAt ? ` â€¢ <span class="text-green-500 font-medium">Done ${new Date(task.completedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>` : ''}
                            </p>
                        </div>
                    </div>
                    <button onclick="deleteTask(${task.id})" class="text-slate-300 hover:text-red-500 transition-colors p-2">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');
        }

        function logout() {
            localStorage.removeItem('pms_token');
            location.reload();
        }

        // Auto-login if token exists
        window.onload = () => {
            const savedToken = localStorage.getItem('pms_token');
            if(savedToken) {
                document.getElementById('gh-token').value = savedToken;
                initWorkspace();
            }
        };
    </script>
</body>
</html>