<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PG-PMS | Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; color: #333333; background-color: #ffffff; }
        .capsule-btn {
            border: 1px solid #e5e7eb;
            border-radius: 9999px;
            padding: 8px 24px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #ffffff;
        }
        .capsule-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            transform: translateY(-1px);
        }
        .status-pill {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .overdue { color: #ef4444 !important; font-weight: 600; }
        input, select {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        input:focus { border-color: #333333; }
        .sidebar-item {
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 12px;
            transition: all 0.2s;
        }
        .sidebar-item:hover { background: #f3f4f6; }
        .sidebar-item.active { background: #333333; color: #ffffff; }
        
        /* Hide scrollbars but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-white">

    <!-- LOGIN SECTION -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-white flex items-center justify-center p-6">
        <div class="max-w-sm w-full text-center">
            <img src="logo.png" alt="PG-PMS Logo" class="h-20 mx-auto mb-8" onerror="this.src='https://ui-avatars.com/api/?name=PG+PMS&background=333&color=fff'">
            <h1 class="text-2xl font-semibold mb-2">Welcome to PG-PMS</h1>
            <p class="text-gray-400 mb-8 text-sm">Enter your workspace passcode to continue.</p>
            <div class="space-y-4">
                <input type="password" id="passcode" placeholder="GitHub Token (ghp_...)" class="w-full text-center">
                <button onclick="login()" class="w-full capsule-btn justify-center bg-black text-white border-none py-3">Enter Workspace</button>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="main-dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        
        <!-- SIDE NAVIGATION -->
        <aside class="w-full md:w-64 border-r border-gray-100 p-6 flex flex-col gap-8 bg-white">
            <div class="flex items-center gap-3">
                <img src="logo.png" alt="Logo" class="h-8" onerror="this.style.display='none'">
                <span class="font-bold text-xl tracking-tight">PG-PMS</span>
            </div>

            <nav class="flex flex-col gap-2 flex-1">
                <div onclick="switchTab('tasks')" id="nav-tasks" class="sidebar-item active"><i class="fas fa-tasks mr-2"></i> Tasks</div>
                <div onclick="switchTab('workspace')" id="nav-workspace" class="sidebar-item"><i class="fas fa-folder-open mr-2"></i> Documents</div>
                <div onclick="switchTab('logs')" id="nav-logs" class="sidebar-item"><i class="fas fa-history mr-2"></i> Activity Log</div>
            </nav>

            <div class="pt-6 border-t border-gray-50">
                <p class="text-[10px] uppercase text-gray-400 font-bold mb-4 tracking-widest">Global Progress</p>
                <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                    <div id="global-progress-bar" class="bg-black h-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <p class="text-xs mt-2 text-gray-500 font-medium"><span id="global-percent">0</span>% Completed</p>
            </div>

            <button onclick="logout()" class="capsule-btn text-red-500 text-xs mt-4 border-red-100 hover:bg-red-50">Logout</button>
        </aside>

        <!-- CONTENT AREA -->
        <main class="flex-1 p-6 md:p-10 overflow-y-auto no-scrollbar">
            
            <!-- HEADER -->
            <div class="flex justify-between items-end mb-10">
                <div>
                    <h2 id="tab-title" class="text-3xl font-semibold">Project Tasks</h2>
                    <p id="tab-desc" class="text-gray-400 text-sm mt-1">Manage and track team responsibilities.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="sync()" class="capsule-btn text-xs"><i class="fas fa-sync" id="sync-icon"></i> Refresh</button>
                    <button id="add-btn" onclick="openModal()" class="capsule-btn bg-black text-white border-none text-xs">New Item</button>
                </div>
            </div>

            <!-- TASKS TAB -->
            <div id="tab-content-tasks" class="space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="space-y-4">
                        <h4 class="text-xs font-bold uppercase tracking-widest text-gray-400">To Do</h4>
                        <div id="col-todo" class="space-y-4"></div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-xs font-bold uppercase tracking-widest text-gray-400">In Progress</h4>
                        <div id="col-progress" class="space-y-4"></div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-xs font-bold uppercase tracking-widest text-gray-400">Review</h4>
                        <div id="col-review" class="space-y-4"></div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-xs font-bold uppercase tracking-widest text-gray-400">Done</h4>
                        <div id="col-done" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- WORKSPACE TAB -->
            <div id="tab-content-workspace" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="doc-container"></div>
            </div>

            <!-- LOGS TAB -->
            <div id="tab-content-logs" class="hidden">
                <div class="bg-white border border-gray-100 rounded-2xl overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 font-medium">
                            <tr>
                                <th class="p-4">Time</th>
                                <th class="p-4">Member</th>
                                <th class="p-4">Action</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL (FOR ADDING TASKS/DOCS) -->
    <div id="modal" class="fixed inset-0 z-[150] bg-black/20 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl">
            <h3 id="modal-title" class="text-xl font-bold mb-6">Add New Task</h3>
            <div id="task-fields" class="space-y-4">
                <input type="text" id="m-task-text" placeholder="Task description..." class="w-full">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="m-task-owner" placeholder="Owner Name" class="w-full">
                    <input type="date" id="m-task-date" class="w-full">
                </div>
            </div>
            <div id="doc-fields" class="space-y-4 hidden">
                <input type="text" id="m-doc-name" placeholder="Document Name..." class="w-full">
                <input type="url" id="m-doc-url" placeholder="URL (Google Drive, Github, etc)" class="w-full">
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeModal()" class="flex-1 capsule-btn justify-center">Cancel</button>
                <button onclick="submitModal()" class="flex-1 capsule-btn bg-black text-white border-none justify-center">Save Item</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const REPO_OWNER = "Pugajjar"; // <-- CHANGE THIS
        const REPO_NAME = "pg-pms";
        const FILE_PATH = "tasks.json";

        let state = { tasks: [], logs: [], docs: [], sha: null, token: null, currentTab: 'tasks' };

        // --- AUTH & SYNC ---

        async function login() {
            const token = document.getElementById('passcode').value;
            if(!token) return;
            state.token = token;
            const success = await sync();
            if(success) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-dashboard').classList.remove('hidden');
                localStorage.setItem('pg_pms_key', token);
            }
        }

        async function sync() {
            const icon = document.getElementById('sync-icon');
            icon.classList.add('fa-spin');
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                    headers: { "Authorization": `token ${state.token}` }
                });
                if(!res.ok) throw new Error();
                const data = await res.json();
                state.sha = data.sha;
                const content = JSON.parse(atob(data.content));
                
                // Compatibility for old versions
                if(Array.isArray(content)) {
                    state.tasks = content;
                    state.logs = [];
                    state.docs = [];
                } else {
                    state.tasks = content.tasks || [];
                    state.logs = content.logs || [];
                    state.docs = content.docs || [];
                }

                render();
                return true;
            } catch (e) {
                alert("Connection failed. Check repo owner name and token permissions.");
                return false;
            } finally { icon.classList.remove('fa-spin'); }
        }

        async function commit(message) {
            const content = btoa(JSON.stringify({
                tasks: state.tasks,
                logs: state.logs,
                docs: state.docs
            }, null, 2));

            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                method: "PUT",
                headers: { "Authorization": `token ${state.token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message, content, sha: state.sha })
            });
            const data = await res.json();
            state.sha = data.content.sha;
            render();
        }

        // --- CORE FEATURES ---

        function addLog(action) {
            state.logs.unshift({
                time: new Date().toISOString(),
                user: state.tasks[0]?.owner || "Team Member",
                action: action
            });
            if(state.logs.length > 50) state.logs.pop();
        }

        function switchTab(tab) {
            state.currentTab = tab;
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');
            
            document.getElementById('tab-content-tasks').classList.add('hidden');
            document.getElementById('tab-content-workspace').classList.add('hidden');
            document.getElementById('tab-content-logs').classList.add('hidden');
            document.getElementById(`tab-content-${tab}`).classList.remove('hidden');

            const headers = {
                tasks: { title: "Project Tasks", desc: "Manage and track team responsibilities." },
                workspace: { title: "Integrated Workspace", desc: "Access shared project documentation and links." },
                logs: { title: "Activity History", desc: "Detailed audit trail of workspace changes." }
            };
            document.getElementById('tab-title').innerText = headers[tab].title;
            document.getElementById('tab-desc').innerText = headers[tab].desc;
            render();
        }

        // --- RENDERING ---

        function render() {
            // Tasks
            const cols = { 'To-Do': 'col-todo', 'In Progress': 'col-progress', 'Review': 'col-review', 'Done': 'col-done' };
            Object.values(cols).forEach(id => document.getElementById(id).innerHTML = '');
            
            let completed = 0;
            state.tasks.forEach(t => {
                if(t.status === 'Done') completed++;
                const isOverdue = t.date && new Date(t.date) < new Date() && t.status !== 'Done';
                
                const card = `
                    <div class="bg-white border border-gray-100 p-4 rounded-2xl shadow-sm hover:shadow-md transition-all group">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-xs font-semibold text-gray-400">@${t.owner || 'unassigned'}</span>
                            <button onclick="deleteItem('tasks', ${t.id})" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-all">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                        <h5 class="text-sm font-medium mb-4">${t.text}</h5>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] ${isOverdue ? 'overdue' : 'text-gray-400'}">
                                <i class="far fa-clock mr-1"></i> ${t.date ? new Date(t.date).toLocaleDateString() : 'No date'}
                            </span>
                            <select onchange="updateStatus(${t.id}, this.value)" class="text-[10px] py-1 px-2 border-gray-100 bg-gray-50">
                                <option ${t.status === 'To-Do' ? 'selected' : ''}>To-Do</option>
                                <option ${t.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option ${t.status === 'Review' ? 'selected' : ''}>Review</option>
                                <option ${t.status === 'Done' ? 'selected' : ''}>Done</option>
                            </select>
                        </div>
                    </div>
                `;
                document.getElementById(cols[t.status] || 'col-todo').innerHTML += card;
            });

            // Progress Bar
            const percent = state.tasks.length ? Math.round((completed / state.tasks.length) * 100) : 0;
            document.getElementById('global-progress-bar').style.width = percent + '%';
            document.getElementById('global-percent').innerText = percent;

            // Workspace
            const docContainer = document.getElementById('doc-container');
            docContainer.innerHTML = state.docs.length ? '' : '<p class="text-gray-400 text-sm">No documents added yet.</p>';
            state.docs.forEach(d => {
                docContainer.innerHTML += `
                    <div class="border border-gray-100 p-6 rounded-3xl hover:bg-gray-50 transition-all relative group">
                        <i class="fas fa-file-alt text-2xl mb-4 block"></i>
                        <h4 class="font-semibold mb-2">${d.name}</h4>
                        <a href="${d.url}" target="_blank" class="text-xs text-blue-500 hover:underline">View Source <i class="fas fa-external-link-alt ml-1"></i></a>
                        <button onclick="deleteItem('docs', ${d.id})" class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                `;
            });

            // Logs
            const logBody = document.getElementById('log-table-body');
            logBody.innerHTML = '';
            state.logs.slice(0, 20).forEach(l => {
                logBody.innerHTML += `
                    <tr class="border-t border-gray-50">
                        <td class="p-4 text-gray-400 text-xs">${new Date(l.time).toLocaleTimeString()}</td>
                        <td class="p-4 font-medium">${l.user}</td>
                        <td class="p-4 text-gray-500">${l.action}</td>
                    </tr>
                `;
            });
        }

        // --- MODAL & ACTIONS ---

        function openModal() {
            const isDoc = state.currentTab === 'workspace';
            document.getElementById('modal-title').innerText = isDoc ? "Add Document" : "Add Task";
            document.getElementById('task-fields').classList.toggle('hidden', isDoc);
            document.getElementById('doc-fields').classList.toggle('hidden', !isDoc);
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function submitModal() {
            if(state.currentTab === 'workspace') {
                const name = document.getElementById('m-doc-name').value;
                const url = document.getElementById('m-doc-url').value;
                if(!name || !url) return;
                state.docs.unshift({ id: Date.now(), name, url });
                addLog(`Linked document: ${name}`);
            } else {
                const text = document.getElementById('m-task-text').value;
                const owner = document.getElementById('m-task-owner').value;
                const date = document.getElementById('m-task-date').value;
                if(!text) return;
                state.tasks.unshift({ id: Date.now(), text, owner, date, status: 'To-Do' });
                addLog(`Created task: ${text}`);
            }
            closeModal();
            await commit("Updated Workspace");
        }

        async function updateStatus(id, newStatus) {
            const t = state.tasks.find(x => x.id === id);
            t.status = newStatus;
            addLog(`Updated status of "${t.text}" to ${newStatus}`);
            await commit("Update Status");
        }

        async function deleteItem(type, id) {
            if(!confirm("Are you sure?")) return;
            state[type] = state[type].filter(x => x.id !== id);
            addLog(`Deleted ${type.slice(0,-1)}`);
            await commit("Deleted Item");
        }

        function logout() { localStorage.removeItem('pg_pms_key'); location.reload(); }

        window.onload = () => {
            const key = localStorage.getItem('pg_pms_key');
            if(key) {
                document.getElementById('passcode').value = key;
                login();
            }
        };
    </script>
</body>
</html>
